<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; right: 0; left: 0; }
        #info-box {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            font-size: 14px;
            width: 250px;
            max-height: 300px;
            overflow-y: auto;
        }
        #info-box h5 { margin: 0; }
        #info-box ul { list-style-type: none; padding: 0; }
        #info-box li { margin: 5px 0; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="info-box">
        <h5>情報</h5>
        <ul id="info-list"></ul>
    </div>

    <script>
        var map = L.map('map', {
            center: [35.5, 139.8],
            zoom: 10,
            zoomControl: true
        });

        var tileLayer = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // 自分の位置を示す青いピンアイコンURLを修正
        const pinIcon = L.icon({
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png', // 通常のピンURL
            iconSize: [25, 41], // ピンの大きさ
            iconAnchor: [12, 41], // ピンの基準点
            popupAnchor: [1, -34] // ポップアップ位置
        });

        // 自分の位置を示す青いマーカー
        var userLat, userLng;
        
        // GPS情報を取得して自分の位置を表示
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;

                // 地図の中心を自分の位置に設定
                map.setView([userLat, userLng], 14);

                // 自分の位置を青いマーカーで表示
                var userMarker = L.marker([userLat, userLng], {
                    icon: L.icon({
                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-blue.png', // 青いピンのURL
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                    })
                }).addTo(map);

                // 自分の位置を中心とした半径20000mの円を描画
                var circle = L.circle([userLat, userLng], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.3,
                    radius: 20000 // 半径20000m
                }).addTo(map);

                // 半径内のピンと多角形をチェック
                updateInfo();
            }, function(error) {
                console.error("位置情報の取得に失敗しました:", error);
            });
        } else {
            alert("このブラウザでは位置情報の取得がサポートされていません。");
        }

        // 距離と向きを計算する関数
        function calculateDistanceAndDirection(lat1, lng1, lat2, lng2) {
            var userLocation = L.latLng(lat1, lng1);
            var targetLocation = L.latLng(lat2, lng2);

            // 距離 (メートル)
            var distance = userLocation.distanceTo(targetLocation);

            // 方向 (度)
            var angle = userLocation.angleTo(targetLocation);
            var direction = (angle + 360) % 360; // 360度方式に変換

            return { distance: distance, direction: direction };
        }

        // 半径内のピンと多角形を更新する関数
        function updateInfo() {
            var infoList = document.getElementById("info-list");
            infoList.innerHTML = ""; // 情報リストをクリア

            // ピンの情報を表示
            fetch('suirotuuhou.json')
                .then(response => response.json())
                .then(data => {
                    console.log("ピンデータ:", data); // デバッグ用ログ

                    data.features.forEach(feature => {
                        const geometry = feature.geometry;
                        const attributes = feature.attributes;
                        const lat = geometry.y;
                        const lng = geometry.x;
                        const popupText = attributes.name; // ポップアップ内容

                        // ピンを地図に表示
                        L.marker([lat, lng], { icon: pinIcon }).addTo(map)
                            .bindPopup(popupText);

                        // 自分の位置からの距離と向きを計算
                        const { distance, direction } = calculateDistanceAndDirection(userLat, userLng, lat, lng);

                        // ピンが円の範囲内かチェック
                        if (distance <= 20000) {
                            var listItem = document.createElement("li");
                            listItem.textContent = `${popupText}・${Math.round(distance)}m・${Math.round(direction)}°`;
                            infoList.appendChild(listItem);
                        }
                    });
                })
                .catch(error => {
                    console.error("JSONデータの読み込みに失敗しました:", error);
                });

            // 多角形の情報を表示
            fetch('polygons.json')
                .then(response => response.json())
                .then(data => {
                    console.log("多角形データ:", data); // デバッグ用ログ

                    data.forEach(polygon => {
                        const coordinates = polygon.coordinates;
                        let closestDistance = Infinity;
                        let closestPoint = null;

                        // 多角形の各頂点との距離を計算し、最も近い頂点を選ぶ
                        coordinates.forEach(coord => {
                            const { distance, direction } = calculateDistanceAndDirection(userLat, userLng, coord[0], coord[1]);
                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestPoint = coord;
                            }
                        });

                        // 自分の位置から最も近い頂点が円の範囲内かチェック
                        if (closestDistance <= 20000) {
                            var listItem = document.createElement("li");
                            listItem.textContent = `${polygon.popup}・${Math.round(closestDistance)}m・${Math.round(closestPoint[2])}°`;
                            infoList.appendChild(listItem);

                            // 多角形を地図に描画
                            var latLngs = polygon.coordinates.map(coord => L.latLng(coord[0], coord[1]));
                            L.polygon(latLngs, { color: 'red' }).addTo(map)
                                .bindPopup(polygon.popup);
                        }
                    });
                })
                .catch(error => {
                    console.error("JSONデータの読み込みに失敗しました:", error);
                });
        }

    </script>
</body>
</html>
